<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DACO</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.fontcdn.ir/Font/Persian/Shabnam/Shabnam.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Modern Faber-Castell-like Color Palette (Adjusted) */
        :root {
            --green-main: #6b8e23; /* Olive Drab - New Green */
            --green-dark: #58731e;
            --orange-main: #FF8C00; /* Brighter Orange */
            --orange-dark: #cc7000;
            --text-color-light: #2c3e50;
            --bg-color-light: #f5f8f0;
            --panel-bg-light: rgba(255, 255, 255, 0.4);
            --border-color-light: #d4d9cc;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --icon-color-light: #2c3e50;
        }
        
        /* Night Mode Palette */
        .night-mode {
            --green-main: #6B8E23;
            --green-dark: #58731e;
            --orange-main: #FFA500;
            --orange-dark: #cc8400;
            --text-color-light: #f5f8f0;
            --bg-color-light: #1c2a37;
            --panel-bg-light: rgba(44, 62, 80, 0.4);
            --border-color-light: #4a6572;
            --shadow-color: rgba(255, 255, 255, 0.1);
            --icon-color-light: #f5f8f0;
        }

        /* General Styles & Layout */
        body {
            font-family: 'Vazirmatn', sans-serif;
            text-align: center;
            direction: rtl;
            background: var(--bg-color-light);
            color: var(--text-color-light);
            margin: 0;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: background 0.5s ease, color 0.5s ease;
        }

        .container {
            background: var(--panel-bg-light);
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 10px 30px var(--shadow-color);
            max-width: 1000px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color-light);
            transition: background 0.5s ease, border 0.5s ease;
        }

        .header {
            text-align: center;
            position: relative;
            margin-bottom: 20px;
        }
        
        /* New header layout to save space */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 16px;
        }

        #appTitle {
            font-size: 4rem;
            font-weight: 800;
            margin: 0;
            color: var(--text-color-light);
        }
        
        .subtitle {
            margin: 4px 0 0;
            color: var(--text-color-light);
            font-size: 1rem;
        }

        /* Top Controls */
        .top-controls {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 16px;
        }
        
        .top-right-controls {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        /* Theme & Language Toggles */
        .toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--icon-color-light);
            transition: color 0.3s ease;
        }

        .toggle-btn svg {
            width: 24px;
            height: 24px;
            stroke: var(--icon-color-light);
            fill: none;
            transition: stroke 0.3s ease;
        }

        .night-mode .toggle-btn .sun-icon {
            display: none;
        }
        .toggle-btn .moon-icon {
            display: none;
        }
        .night-mode .toggle-btn .moon-icon {
            display: inline-block;
        }

        .lang-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .lang-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .lang-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color-light);
            transition: .4s;
            border-radius: 34px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 8px;
            color: var(--text-color-light);
            font-size: 1rem;
        }
        
        .lang-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--green-main);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .lang-slider:before {
            transform: translateX(26px);
            background-color: var(--orange-main);
        }
        
        .lang-slider #fa-label {
            position: absolute;
            right: 8px;
            z-index: 1;
        }
        .lang-slider #en-label {
            position: absolute;
            left: 8px;
            z-index: 1;
        }

        /* Dropdown for download options */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--panel-bg-light);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color-light);
            direction: rtl;
        }
        
        .dropdown-content button {
            color: var(--text-color-light);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            background: none;
            border: none;
            width: 100%;
            text-align: right;
            cursor: pointer;
            border-radius: 12px;
            transition: background-color 0.2s ease;
        }
        
        .dropdown-content button:hover {
            background-color: var(--green-main);
            color: white;
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* Control Panels */
        .control-panel-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 16px;
            width: 100%;
        }
        
        .panel-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: absolute;
            top: 0;
            right: 0;
            z-index: 10;
            padding: 24px;
            pointer-events: none;
        }
        
        .panel {
            background-color: var(--panel-bg-light);
            border-radius: 12px;
            padding: 16px;
            min-width: 250px;
            box-shadow: 0 4px 6px var(--shadow-color);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color-light);
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: all 0.5s ease;
            max-height: 0;
            overflow: hidden;
            padding: 0 16px;
            opacity: 0;
            pointer-events: auto;
            align-self: flex-end;
        }
        
        .panel.open {
            max-height: 1000px;
            padding: 16px;
            opacity: 1;
        }

        .panel-header {
            font-weight: 600;
            color: var(--text-color-light);
            border-bottom: 1px solid var(--border-color-light);
            padding-bottom: 8px;
            margin-bottom: 8px;
        }
        
        /* Input & Button Styles */
        input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            border: 2px solid var(--border-color-light);
            background-color: var(--panel-bg-light);
            color: var(--text-color-light);
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: fit-content;
            margin: 0 auto 24px auto;
            pointer-events: auto;
        }

        .custom-file-upload:hover {
            border-color: var(--green-main);
            box-shadow: 0 0 0 3px rgba(107, 142, 35, 0.2);
        }
        
        input[type="text"],
        input[type="number"],
        select,
        button {
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid var(--border-color-light);
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
            font-family: inherit;
            background-color: var(--panel-bg-light);
            color: var(--text-color-light);
            pointer-events: auto;
        }

        input:focus, select:focus {
            border-color: var(--green-main);
            box-shadow: 0 0 0 3px rgba(107, 142, 35, 0.2);
        }
        
        select {
            flex: 1;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .add-font-btn {
            background: var(--green-main);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 2rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .add-font-btn:hover {
            background: var(--green-dark);
        }

        button.primary {
            background: var(--green-main);
            color: white;
            cursor: pointer;
            border: none;
            font-weight: 700;
        }

        button.primary:hover {
            background: var(--green-dark);
        }
        
        button.secondary {
            background: var(--orange-main);
            color: white;
            cursor: pointer;
            border: none;
            font-weight: 700;
        }

        button.secondary:hover {
            background: var(--orange-dark);
        }
        
        .btn-group {
            display: flex;
            gap: 16px;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-group label {
            min-width: 90px;
            text-align: right;
            font-size: 0.9rem;
            color: var(--text-color-light);
        }
        
        [lang="en"] .slider-group label {
            text-align: left;
        }

        .slider-group input[type="range"] {
            flex-grow: 1;
            -webkit-appearance: none;
            background: var(--border-color-light);
            height: 6px;
            border-radius: 3px;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--orange-main); 
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }

        .slider-value {
            font-weight: 600;
            min-width: 30px;
            text-align: left;
        }

        /* Black/White Toggle Switch */
        .color-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .color-toggle-label {
            font-weight: 600;
            color: var(--text-color-light);
            font-size: 0.9rem;
        }

        .color-toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .color-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .color-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color-light);
            transition: .4s;
            border-radius: 34px;
        }

        .color-toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .color-toggle-slider {
            background-color: var(--green-main);
        }

        input:checked + .color-toggle-slider:before {
            transform: translateX(26px);
            background-color: black;
        }
        
        .color-panel-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .font-add-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .backdrop-panel {
            border-top: 1px solid var(--border-color-light);
            padding-top: 12px;
            margin-top: 12px;
        }

        /* Canvas & Interaction */
        .canvas-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .canvas-container {
            position: relative;
            max-width: 100%;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color-light);
            width: 100%;
            height: auto;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
            touch-action: none;
        }
        
        #canvas.dragover {
            border: 2px dashed var(--orange-main);
            box-shadow: 0 0 10px rgba(255, 140, 0, 0.5);
        }
        
        /* New layout for top section */
        .top-section-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 16px;
        }
        
        .top-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            width: 100%;
        }
        
        /* New Circle Styles */
        .circles-container {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: -8px;
            margin-bottom: 24px;
            width: 100%;
        }
        
        .circle {
            width: 80px;
            height: 80px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            pointer-events: auto;
        }
        
        .night-mode .circle {
            background-color: rgba(44, 62, 80, 0.5);
        }
        
        .circle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        
        .circle.active {
            box-shadow: 0 0 0 4px var(--orange-main);
        }
        
        .circle svg {
            width: 40px;
            height: 40px;
            stroke: var(--icon-color-light);
            stroke-width: 2;
            fill: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-section-container">
             <div class="header-top">
                <div class="top-controls">
                    <button class="toggle-btn" id="themeToggle">
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <label class="lang-switch">
                        <input type="checkbox" id="langToggle">
                        <span class="lang-slider">
                            <span id="fa-label">فا</span>
                            <span id="en-label">En</span>
                        </span>
                    </label>
                </div>
                <div class="top-right-controls">
                     <div class="dropdown">
                        <button class="primary" id="downloadBtn">دانلود عکس</button>
                        <div class="dropdown-content">
                            <button id="downloadHigh">کیفیت بالا</button>
                            <button id="downloadMedium">کیفیت متوسط</button>
                            <button id="downloadLow">کیفیت پایین</button>
                        </div>
                     </div>
                     <div class="dropdown">
                        <button class="secondary" id="downloadTextBtn">دانلود متن</button>
                         <div class="dropdown-content">
                            <button id="downloadTextHigh">کیفیت بالا</button>
                            <button id="downloadTextMedium">کیفیت متوسط</button>
                            <button id="downloadTextLow">کیفیت پایین</button>
                        </div>
                     </div>
                </div>
             </div>
             <div class="header">
                 <h2 id="appTitle">DACO</h2>
                 <p class="subtitle" id="appSubtitle">ساخته شده توسط @darabiparham</p>
             </div>
        </div>
       
        <div class="circles-container">
            <div class="circle" id="circle-text">
                <i class="fa-solid fa-font fa-xl" style="color: var(--icon-color-light);"></i>
            </div>
            <div class="circle" id="circle-color">
                <i class="fa-solid fa-palette fa-xl" style="color: var(--icon-color-light);"></i>
            </div>
            <div class="circle" id="circle-effects">
                <i class="fa-solid fa-wand-magic-sparkles fa-xl" style="color: var(--icon-color-light);"></i>
            </div>
        </div>
        
        <div class="btn-group">
            <label for="imageInput" class="custom-file-upload">
                <i class="fa-regular fa-image fa-lg"></i>
                <span id="label-image">آپلود عکس</span>
            </label>
            <input type="file" id="imageInput" accept="image/*">
            <button class="primary" id="copyStickerBtn">کپی استیکر</button>
        </div>


        <div class="canvas-wrapper">
            <div class="canvas-container">
                <canvas id="canvas"></canvas>
                <div class="panel-container">
                    <div class="panel" id="panel-text">
                        <div class="panel-header" id="panel-text-header">متن</div>
                        <input type="text" id="textInput" placeholder="متن خودت رو بنویس">
                        
                        <div class="font-add-group">
                            <label for="fontSelector" id="label-font">فونت</label>
                            <select id="fontSelector">
                                <option value="Vazirmatn" selected>Vazirmatn</option>
                                <option value="Shabnam">Shabnam</option>
                            </select>
                             <label for="fontInput" class="add-font-btn">+</label>
                             <input type="file" id="fontInput" accept=".ttf,.otf">
                        </div>
                        <div class="slider-group">
                            <label for="fontSizeSlider" id="label-font-size">سایز فونت</label>
                            <input type="range" id="fontSizeSlider" min="0" max="100" value="50">
                            <span id="fontSizeValue" class="slider-value">۵۰</span>
                        </div>
                    </div>

                    <div class="panel" id="panel-color">
                        <div class="panel-header" id="panel-color-opacity">رنگ و اپسیتی</div>
                        
                        <div class="color-toggle-container">
                            <span class="color-toggle-label" id="label-black-white-text">رنگ متن سیاه/سفید</span>
                            <label class="color-toggle-switch">
                                <input type="checkbox" id="blackWhiteToggle">
                                <span class="color-toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="color-panel-group">
                            <div class="slider-group">
                                <label for="redSlider" id="label-red">قرمز</label>
                                <input type="range" id="redSlider" min="0" max="255" value="0">
                                <span id="redValue" class="slider-value">۰</span>
                            </div>
                            <div class="slider-group">
                                <label for="greenSlider" id="label-green">سبز</label>
                                <input type="range" id="greenSlider" min="0" max="255" value="0">
                                <span id="greenValue" class="slider-value">۰</span>
                            </div>
                            <div class="slider-group">
                                <label for="blueSlider" id="label-blue">آبی</label>
                                <input type="range" id="blueSlider" min="0" max="255" value="0">
                                <span id="blueValue" class="slider-value">۰</span>
                            </div>
                        </div>

                        <div class="slider-group">
                            <label for="opacitySlider" id="label-opacity">اپسیتی متن</label>
                            <input type="range" id="opacitySlider" min="0" max="100" value="100">
                            <span id="opacityValue" class="slider-value">۱۰۰٪</span>
                        </div>
                    </div>

                    <div class="panel" id="panel-effects">
                        <div class="panel-header" id="panel-effects-header">افکت‌ها</div>
                        <div class="slider-group">
                            <label for="shadowSlider" id="label-shadow">سایه</label>
                            <input type="range" id="shadowSlider" min="0" max="20" value="0">
                            <span id="shadowValue" class="slider-value">۰</span>
                        </div>
                        <div class="slider-group">
                            <label for="strokeSlider" id="label-stroke">حاشیه</label>
                            <input type="range" id="strokeSlider" min="0" max="10" value="0">
                            <span id="strokeValue" class="slider-value">۰</span>
                        </div>
                        <div class="slider-group">
                            <label for="glowSlider" id="label-glow">درخشش</label>
                            <input type="range" id="glowSlider" min="0" max="20" value="0">
                            <span id="glowValue" class="slider-value">۰</span>
                        </div>

                        <div class="backdrop-panel">
                            <div class="panel-header" id="panel-backdrop">کادر پشت متن</div>
                            <div class="color-toggle-container">
                                <span class="color-toggle-label" id="label-black-white-backdrop">رنگ کادر سیاه/سفید</span>
                                <label class="color-toggle-switch">
                                    <input type="checkbox" id="blackWhiteBackdropToggle">
                                    <span class="color-toggle-slider"></span>
                                </label>
                            </div>
                            <div class="slider-group">
                                <label for="backdropOpacitySlider" id="label-backdrop-opacity">اپسیتی کادر</label>
                                <input type="range" id="backdropOpacitySlider" min="0" max="100" value="0">
                                <span id="backdropOpacityValue" class="slider-value">۰٪</span>
                            </div>
                            <div class="slider-group">
                                <label for="backdropRadiusSlider" id="label-backdrop-radius">گردی گوشه‌ها</label>
                                <input type="range" id="backdropRadiusSlider" min="0" max="100" value="0">
                                <span id="backdropRadiusValue" class="slider-value">۰</span>
                            </div>
                            <div class="slider-group">
                                <label for="backdropWidthSlider" id="label-backdrop-width">پهنای کادر</label>
                                <input type="range" id="backdropWidthSlider" min="0" max="100" value="0">
                                <span id="backdropWidthValue" class="slider-value">۰</span>
                            </div>
                             <div class="slider-group">
                                <label for="backdropHeightSlider" id="label-backdrop-height">ارتفاع کادر</label>
                                <input type="range" id="backdropHeightSlider" min="0" max="100" value="0">
                                <span id="backdropHeightValue" class="slider-value">۰</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const fontInput = document.getElementById('fontInput');
        const textInput = document.getElementById('textInput');
        const fontSelector = document.getElementById('fontSelector');
        const fontSizeSlider = document.getElementById('fontSizeSlider');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const redSlider = document.getElementById('redSlider');
        const redValue = document.getElementById('redValue');
        const greenSlider = document.getElementById('greenSlider');
        const greenValue = document.getElementById('greenValue');
        const blueSlider = document.getElementById('blueSlider');
        const blueValue = document.getElementById('blueValue');
        const opacitySlider = document.getElementById('opacitySlider');
        const opacityValue = document.getElementById('opacityValue');
        const shadowSlider = document.getElementById('shadowSlider');
        const shadowValue = document.getElementById('shadowValue');
        const strokeSlider = document.getElementById('strokeSlider');
        const strokeValue = document.getElementById('strokeValue');
        const glowSlider = document.getElementById('glowSlider');
        const glowValue = document.getElementById('glowValue');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadTextBtn = document.getElementById('downloadTextBtn');
        const downloadHighBtn = document.getElementById('downloadHigh');
        const downloadMediumBtn = document.getElementById('downloadMedium');
        const downloadLowBtn = document.getElementById('downloadLow');
        const downloadTextHighBtn = document.getElementById('downloadTextHigh');
        const downloadTextMediumBtn = document.getElementById('downloadTextMedium');
        const downloadTextLowBtn = document.getElementById('downloadTextLow');
        const themeToggle = document.getElementById('themeToggle');
        const langToggle = document.getElementById('langToggle');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const backdropOpacitySlider = document.getElementById('backdropOpacitySlider');
        const backdropWidthSlider = document.getElementById('backdropWidthSlider');
        const backdropHeightSlider = document.getElementById('backdropHeightSlider');
        const backdropRadiusSlider = document.getElementById('backdropRadiusSlider');
        const backdropOpacityValue = document.getElementById('backdropOpacityValue');
        const backdropWidthValue = document.getElementById('backdropWidthValue');
        const backdropHeightValue = document.getElementById('backdropHeightValue');
        const backdropRadiusValue = document.getElementById('backdropRadiusValue');
        const blackWhiteToggle = document.getElementById('blackWhiteToggle');
        const blackWhiteBackdropToggle = document.getElementById('blackWhiteBackdropToggle');
        const copyStickerBtn = document.getElementById('copyStickerBtn');

        const panels = document.querySelectorAll('.panel');
        const circles = document.querySelectorAll('.circle');
        
        const panelText = document.getElementById('panel-text');
        const panelColor = document.getElementById('panel-color');
        const panelEffects = document.getElementById('panel-effects');
        const circleText = document.getElementById('circle-text');
        const circleColor = document.getElementById('circle-color');
        const circleEffects = document.getElementById('circle-effects');


        const translations = {
            fa: {
                appTitle: 'DACO',
                appSubtitle: 'ساخته شده توسط @darabiparham',
                labelImage: 'آپلود عکس',
                initialCanvasText: 'یک عکس بارگذاری کنید',
                panelText: 'متن',
                textInputPlaceholder: 'متن خودت رو بنویس',
                labelFont: 'فونت',
                labelFontSize: 'سایز فونت',
                panelColorOpacity: 'رنگ و اپسیتی',
                labelBlackWhiteText: 'رنگ متن سیاه/سفید',
                labelRed: 'قرمز',
                labelGreen: 'سبز',
                labelBlue: 'آبی',
                labelOpacity: 'اپسیتی متن',
                panelEffects: 'افکت‌ها',
                labelShadow: 'سایه',
                labelStroke: 'حاشیه',
                labelGlow: 'درخشش',
                panelBackdrop: 'کادر پشت متن',
                labelBlackWhiteBackdrop: 'رنگ کادر سیاه/سفید',
                labelBackdropOpacity: 'اپسیتی کادر',
                labelBackdropRadius: 'گردی گوشه‌ها',
                labelBackdropWidth: 'پهنای کادر',
                labelBackdropHeight: 'ارتفاع کادر',
                downloadBtn: 'دانلود عکس',
                downloadTextBtn: 'دانلود متن',
                downloadHigh: 'کیفیت بالا',
                downloadMedium: 'کیفیت متوسط',
                downloadLow: 'کیفیت پایین',
                copyStickerBtn: 'کپی استیکر',
                alertImage: 'لطفاً ابتدا یک عکس بارگذاری کنید.',
                alertText: 'لطفاً متنی برای دانلود وارد کنید.',
                alertFont: 'شما می‌توانید حداکثر ۳ فونت سفارشی اضافه کنید.',
                alertFontSuccess: (fileName) => `فونت ${fileName} بارگذاری شد!`,
                alertFontError: (message) => `خطا در بارگذاری فونت: ${message}`,
                alertNoTextToCopy: 'لطفاً متنی برای کپی کردن وارد کنید.',
                alertCopySuccess: 'استیکر با موفقیت کپی شد!'
            },
            en: {
                appTitle: 'DACO',
                appSubtitle: 'Made by @darabiparham',
                labelImage: 'Upload Image',
                initialCanvasText: 'Upload an image',
                panelText: 'Text',
                textInputPlaceholder: 'Write your text',
                labelFont: 'Font',
                labelFontSize: 'Font Size',
                panelColorOpacity: 'Color & Opacity',
                labelBlackWhiteText: 'Text Color Black/White',
                labelRed: 'Red',
                labelGreen: 'Green',
                labelBlue: 'Blue',
                labelOpacity: 'Text Opacity',
                panelEffects: 'Effects',
                labelShadow: 'Shadow',
                labelStroke: 'Stroke',
                labelGlow: 'Glow',
                panelBackdrop: 'Text Backdrop',
                labelBlackWhiteBackdrop: 'Backdrop Color Black/White',
                labelBackdropOpacity: 'Backdrop Opacity',
                labelBackdropRadius: 'Corner Radius',
                labelBackdropWidth: 'Backdrop Width',
                labelBackdropHeight: 'Backdrop Height',
                downloadBtn: 'Download Image',
                downloadTextBtn: 'Download Text',
                downloadHigh: 'High Quality',
                downloadMedium: 'Medium Quality',
                downloadLow: 'Low Quality',
                copyStickerBtn: 'Copy Sticker',
                alertImage: 'Please upload an image first.',
                alertText: 'Please enter text to download.',
                alertFont: 'You can add a maximum of 3 custom fonts.',
                alertFontSuccess: (fileName) => `Font ${fileName} loaded!`,
                alertFontError: (message) => `Error loading font: ${message}`,
                alertNoTextToCopy: 'Please enter text to copy.',
                alertCopySuccess: 'Sticker copied successfully!'
            }
        };

        let currentLang = 'fa';
        const numToFa = (num) => String(num).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);

        function setLanguage(lang) {
            const t = translations[lang];
            document.documentElement.lang = lang;
            document.body.style.direction = lang === 'fa' ? 'rtl' : 'ltr';

            document.getElementById('appTitle').textContent = t.appTitle;
            document.getElementById('appSubtitle').textContent = t.appSubtitle;
            document.getElementById('label-image').textContent = t.labelImage;
            document.getElementById('panel-text-header').textContent = t.panelText;
            document.getElementById('textInput').placeholder = t.textInputPlaceholder;
            document.getElementById('label-font').textContent = t.labelFont;
            document.getElementById('label-font-size').textContent = t.labelFontSize;
            document.getElementById('panel-color-opacity').textContent = t.panelColorOpacity;
            document.getElementById('label-black-white-text').textContent = t.labelBlackWhiteText;
            document.getElementById('label-red').textContent = t.labelRed;
            document.getElementById('label-green').textContent = t.labelGreen;
            document.getElementById('label-blue').textContent = t.labelBlue;
            document.getElementById('label-opacity').textContent = t.labelOpacity;
            document.getElementById('panel-effects-header').textContent = t.panelEffects;
            document.getElementById('label-shadow').textContent = t.labelShadow;
            document.getElementById('label-stroke').textContent = t.labelStroke;
            document.getElementById('label-glow').textContent = t.labelGlow;
            document.getElementById('panel-backdrop').textContent = t.panelBackdrop;
            document.getElementById('label-black-white-backdrop').textContent = t.labelBlackWhiteBackdrop;
            document.getElementById('label-backdrop-opacity').textContent = t.labelBackdropOpacity;
            document.getElementById('label-backdrop-radius').textContent = t.labelBackdropRadius;
            document.getElementById('label-backdrop-width').textContent = t.labelBackdropWidth;
            document.getElementById('label-backdrop-height').textContent = t.labelBackdropHeight;
            document.getElementById('downloadBtn').textContent = t.downloadBtn;
            document.getElementById('downloadTextBtn').textContent = t.downloadTextBtn;
            document.getElementById('downloadHigh').textContent = t.downloadHigh;
            document.getElementById('downloadMedium').textContent = t.downloadMedium;
            document.getElementById('downloadLow').textContent = t.downloadLow;
            document.getElementById('downloadTextHigh').textContent = t.downloadHigh;
            document.getElementById('downloadTextMedium').textContent = t.downloadMedium;
            document.getElementById('downloadTextLow').textContent = t.downloadLow;
            document.getElementById('copyStickerBtn').textContent = t.copyStickerBtn;

            updateSliderValues();
            drawCanvas(); 
        }

        let img = null;
        let originalImgSize = { width: 0, height: 0 };
        let fontSize = 50;
        let textColor = 'rgb(0,0,0)';
        let textOpacity = 1;
        let currentFont = 'Vazirmatn';
        let customFontsCount = 0;
        const MAX_CUSTOM_FONTS = 3;
        let shadowBlur = 0;
        let strokeWidth = 0;
        let glowBlur = 0;
        let isDragging = false;
        let isResizing = false;
        let selectedTextBox = { x: 0, y: 0, width: 200, height: 60 };
        let dragStartX = 0;
        let dragStartY = 0;
        let backdropColor = 'rgb(0,0,0)';
        let backdropOpacity = 0;
        let backdropRadius = 0; 
        let backdropWidthPercentage = 0;
        let backdropHeightPercentage = 0;
        let textMetrics = null;

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('night-mode');
        });

        langToggle.addEventListener('change', (e) => {
            currentLang = e.target.checked ? 'en' : 'fa';
            setLanguage(currentLang);
        });
        
        function handleAccordion(panelId) {
            panels.forEach(panel => {
                if (panel.id === panelId) {
                    panel.classList.toggle('open');
                } else {
                    panel.classList.remove('open');
                }
            });
            circles.forEach(circle => {
                if (`panel-${circle.id.split('-')[1]}` === panelId) {
                    circle.classList.toggle('active');
                } else {
                    circle.classList.remove('active');
                }
            });
        }
        
        circleText.addEventListener('click', () => handleAccordion('panel-text'));
        circleColor.addEventListener('click', () => handleAccordion('panel-color'));
        circleEffects.addEventListener('click', () => handleAccordion('panel-effects'));


        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            loadImage(file);
        });

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                img = new Image();
                img.onload = () => {
                    originalImgSize.width = img.width;
                    originalImgSize.height = img.height;
                    const containerWidth = document.querySelector('.canvas-container').offsetWidth;
                    const scaleFactor = containerWidth / img.width;
                    canvas.width = img.width * scaleFactor;
                    canvas.height = img.height * scaleFactor;
                    selectedTextBox.x = (canvas.width - selectedTextBox.width) / 2;
                    selectedTextBox.y = (canvas.height - selectedTextBox.height) / 2;
                    drawCanvas();
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        fontInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || customFontsCount >= MAX_CUSTOM_FONTS) {
                if (customFontsCount >= MAX_CUSTOM_FONTS) {
                    alert(translations[currentLang].alertFont);
                }
                return;
            }
            const fontName = `CustomFont_${Date.now()}`;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const font = new FontFace(fontName, ev.target.result);
                font.load().then(() => {
                    document.fonts.add(font);
                    const option = document.createElement('option');
                    option.value = fontName;
                    option.textContent = file.name.split('.')[0];
                    fontSelector.appendChild(option);
                    customFontsCount++;
                    currentFont = fontName;
                    fontSelector.value = fontName;
                    drawCanvas();
                    alert(translations[currentLang].alertFontSuccess(file.name));
                }).catch(error => {
                    alert(translations[currentLang].alertFontError(error.message));
                });
            };
            reader.readAsArrayBuffer(file);
        });

        textInput.addEventListener('input', drawCanvas);
        fontSelector.addEventListener('change', (e) => { currentFont = e.target.value; drawCanvas(); });
        fontSizeSlider.addEventListener('input', (e) => {
            fontSize = parseInt(e.target.value, 10);
            updateSliderValues();
            drawCanvas();
        });
        redSlider.addEventListener('input', updateTextColor);
        greenSlider.addEventListener('input', updateTextColor);
        blueSlider.addEventListener('input', updateTextColor);
        opacitySlider.addEventListener('input', (e) => {
            textOpacity = parseInt(e.target.value, 10) / 100;
            updateSliderValues();
            drawCanvas();
        });
        shadowSlider.addEventListener('input', (e) => {
            shadowBlur = parseInt(e.target.value, 10);
            updateSliderValues();
            drawCanvas();
        });
        strokeSlider.addEventListener('input', (e) => {
            strokeWidth = parseInt(e.target.value, 10);
            updateSliderValues();
            drawCanvas();
        });
        glowSlider.addEventListener('input', (e) => {
            glowBlur = parseInt(e.target.value, 10);
            updateSliderValues();
            drawCanvas();
        });
        
        backdropOpacitySlider.addEventListener('input', (e) => {
            backdropOpacity = parseInt(e.target.value, 10) / 100;
            updateSliderValues();
            drawCanvas();
        });
        backdropRadiusSlider.addEventListener('input', (e) => {
            backdropRadius = parseInt(e.target.value, 10);
            updateSliderValues();
            drawCanvas();
        });
        backdropWidthSlider.addEventListener('input', (e) => {
            backdropWidthPercentage = parseInt(e.target.value, 10);
            updateSliderValues();
            drawCanvas();
        });
        backdropHeightSlider.addEventListener('input', (e) => {
            backdropHeightPercentage = parseInt(e.target.value, 10);
            updateSliderValues();
            drawCanvas();
        });


        function updateSliderValues() {
            const formatValue = (value) => currentLang === 'fa' ? numToFa(value) : value;
            fontSizeValue.textContent = formatValue(fontSizeSlider.value);
            redValue.textContent = formatValue(redSlider.value);
            greenValue.textContent = formatValue(greenSlider.value);
            blueValue.textContent = formatValue(blueSlider.value);
            opacityValue.textContent = formatValue(opacitySlider.value) + '%';
            shadowValue.textContent = formatValue(shadowSlider.value);
            strokeValue.textContent = formatValue(strokeSlider.value);
            glowValue.textContent = formatValue(glowSlider.value);
            backdropOpacityValue.textContent = formatValue(backdropOpacitySlider.value) + '٪';
            backdropRadiusValue.textContent = formatValue(backdropRadiusSlider.value);
            backdropWidthValue.textContent = formatValue(backdropWidthSlider.value);
            backdropHeightValue.textContent = formatValue(backdropHeightSlider.value);
        }

        blackWhiteToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                redSlider.value = 0;
                greenSlider.value = 0;
                blueSlider.value = 0;
            } else {
                redSlider.value = 255;
                greenSlider.value = 255;
                blueSlider.value = 255;
            }
            updateTextColor();
        });

        function updateTextColor() {
            const r = redSlider.value;
            const g = greenSlider.value;
            const b = blueSlider.value;
            textColor = `rgb(${r},${g},${b})`;
            updateSliderValues();
            drawCanvas();
        }

        blackWhiteBackdropToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                backdropColor = 'rgb(0,0,0)';
            } else {
                backdropColor = 'rgb(255,255,255)';
            }
            updateSliderValues(); 
            drawCanvas();
        });
        
        function drawCanvas() {
            let initialCanvas = false;
            if (!img) {
                initialCanvas = true;
                const canvasContainer = document.querySelector('.canvas-container');
                const desiredWidth = canvasContainer.offsetWidth;
                canvas.width = desiredWidth;
                canvas.height = desiredWidth * 0.6;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (img) {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = "#e0e0e0";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            const textToDraw = textInput.value;
            const hasText = textToDraw.trim() !== '';

            if (!hasText) {
                if (!img) {
                    ctx.fillStyle = "#888";
                    ctx.font = "20px Vazirmatn";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(translations[currentLang].initialCanvasText, canvas.width / 2, canvas.height / 2);
                }
                return;
            }

            let calculatedFontSize = fontSize;
            ctx.font = `${calculatedFontSize}px ${currentFont}`;
            textMetrics = ctx.measureText(textToDraw);

            // Calculate font size based on slider value and canvas width
            if (fontSize > 0) {
                 let tempFontSize = (fontSize / 100) * canvas.width;
                 ctx.font = `${tempFontSize}px ${currentFont}`;
                 let tempMetrics = ctx.measureText(textToDraw);
                 // If the text width is too big, scale it down proportionally
                 if (tempMetrics.width > canvas.width) {
                     const scaleFactor = (canvas.width / tempMetrics.width) * 0.95;
                     calculatedFontSize = tempFontSize * scaleFactor;
                 } else {
                    calculatedFontSize = tempFontSize;
                 }
            } else {
                calculatedFontSize = 0;
            }
            ctx.font = `${calculatedFontSize}px ${currentFont}`;
            textMetrics = ctx.measureText(textToDraw);

            const backdropPaddingX = (backdropWidthPercentage / 100) * canvas.width;
            const backdropPaddingY = (backdropHeightPercentage / 100) * canvas.height;
            
            selectedTextBox.width = textMetrics.width + backdropPaddingX;
            selectedTextBox.height = calculatedFontSize * 1.5 + backdropPaddingY;
            
            if (textMetrics.width > 0 && selectedTextBox.width < 50) selectedTextBox.width = 50;

            if (selectedTextBox.width > canvas.width) selectedTextBox.width = canvas.width;
            if (selectedTextBox.height > canvas.height) selectedTextBox.height = canvas.height;


            selectedTextBox.x = Math.max(0, Math.min(selectedTextBox.x, canvas.width - selectedTextBox.width));
            selectedTextBox.y = Math.max(0, Math.min(selectedTextBox.y, canvas.height - selectedTextBox.height));

            if (backdropOpacity > 0) {
                ctx.fillStyle = backdropColor;
                ctx.globalAlpha = backdropOpacity;
                const borderRadius = (backdropRadius / 100) * Math.min(selectedTextBox.width, selectedTextBox.height) / 2; 

                ctx.beginPath();
                ctx.moveTo(selectedTextBox.x + borderRadius, selectedTextBox.y);
                ctx.lineTo(selectedTextBox.x + selectedTextBox.width - borderRadius, selectedTextBox.y);
                ctx.arcTo(selectedTextBox.x + selectedTextBox.width, selectedTextBox.y, selectedTextBox.x + selectedTextBox.width, selectedTextBox.y + borderRadius, borderRadius);
                ctx.lineTo(selectedTextBox.x + selectedTextBox.width, selectedTextBox.y + selectedTextBox.height - borderRadius);
                ctx.arcTo(selectedTextBox.x + selectedTextBox.width, selectedTextBox.y + selectedTextBox.height, selectedTextBox.x + selectedTextBox.width - borderRadius, selectedTextBox.y + selectedTextBox.height, borderRadius);
                ctx.lineTo(selectedTextBox.x + borderRadius, selectedTextBox.y + selectedTextBox.height);
                ctx.arcTo(selectedTextBox.x, selectedTextBox.y + selectedTextBox.height, selectedTextBox.x, selectedTextBox.y + selectedTextBox.height - borderRadius, borderRadius);
                ctx.lineTo(selectedTextBox.x, selectedTextBox.y + borderRadius);
                ctx.arcTo(selectedTextBox.x, selectedTextBox.y, selectedTextBox.x + borderRadius, selectedTextBox.y, borderRadius);
                ctx.closePath();
                ctx.fill();
                ctx.globalAlpha = 1;
            }
            
            ctx.strokeStyle = '#556B2F';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            if (ctx.roundRect) {
                ctx.roundRect(selectedTextBox.x, selectedTextBox.y, selectedTextBox.width, selectedTextBox.height, 10);
            } else {
                ctx.rect(selectedTextBox.x, selectedTextBox.y, selectedTextBox.width, selectedTextBox.height);
            }
            ctx.stroke();
            ctx.setLineDash([]);


            ctx.shadowColor = `rgb(0,0,0)`;
            ctx.shadowBlur = shadowBlur;
            ctx.strokeStyle = `rgb(0,0,0)`;
            ctx.lineWidth = strokeWidth * 2;
            ctx.lineJoin = 'round';
            ctx.miterLimit = 2;
            
            if (strokeWidth > 0) {
                 ctx.strokeText(textToDraw, selectedTextBox.x + selectedTextBox.width / 2, selectedTextBox.y + selectedTextBox.height / 2);
            }

            if (glowBlur > 0) {
                ctx.shadowColor = textColor;
                ctx.shadowBlur = glowBlur;
                ctx.fillStyle = textColor;
                ctx.globalAlpha = textOpacity;
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(textToDraw, selectedTextBox.x + selectedTextBox.width / 2, selectedTextBox.y + selectedTextBox.height / 2);
                ctx.globalAlpha = 1;
                ctx.shadowBlur = 0;
            }

            ctx.font = `${calculatedFontSize}px ${currentFont}`;
            ctx.fillStyle = textColor;
            ctx.globalAlpha = textOpacity;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(textToDraw, selectedTextBox.x + selectedTextBox.width / 2, selectedTextBox.y + selectedTextBox.height / 2);
            ctx.globalAlpha = 1;
            ctx.shadowBlur = 0;
            
            ctx.fillStyle = '#FF8C00';
            ctx.beginPath();
            ctx.arc(selectedTextBox.x + selectedTextBox.width, selectedTextBox.y + selectedTextBox.height, 10, 0, 2 * Math.PI);
            ctx.fill();
        }

        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX = e.clientX;
            let clientY = e.clientY;
            if (isTouchDevice && e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            }
            return {
                x: (clientX - rect.left) / (rect.width / canvas.width),
                y: (clientY - rect.top) / (rect.height / canvas.height)
            };
        }
        canvas.addEventListener(isTouchDevice ? 'touchstart' : 'mousedown', (e) => {
            e.preventDefault();
            const { x, y } = getCoords(e);
            const resizeHandleDistance = Math.hypot(x - (selectedTextBox.x + selectedTextBox.width), y - (selectedTextBox.y + selectedTextBox.height));
            if (resizeHandleDistance < 20) {
                isResizing = true;
                return;
            }
            if (x >= selectedTextBox.x && x <= selectedTextBox.x + selectedTextBox.width && y >= selectedTextBox.y && y <= selectedTextBox.y + selectedTextBox.height) {
                isDragging = true;
                dragStartX = x - selectedTextBox.x;
                dragStartY = y - selectedTextBox.y;
            }
        });
        canvas.addEventListener(isTouchDevice ? 'touchmove' : 'mousemove', (e) => {
            if (!isDragging && !isResizing) return;
            e.preventDefault();
            const { x, y } = getCoords(e);
            if (isDragging) {
                selectedTextBox.x = Math.max(0, Math.min(x - dragStartX, canvas.width - selectedTextBox.width));
                selectedTextBox.y = Math.max(0, Math.min(y - dragStartY, canvas.height - selectedTextBox.height));
            } else if (isResizing) {
                const newWidth = Math.max(100, x - selectedTextBox.x);
                const newHeight = Math.max(50, y - selectedTextBox.y);
                const newFontSize = newHeight / 1.5;
                
                const percentageOfCanvas = (newFontSize / canvas.width) * 100;
                fontSize = Math.round(percentageOfCanvas);
                if (fontSize > 100) fontSize = 100;
                fontSizeSlider.value = fontSize;
                
                updateSliderValues();
            }
            drawCanvas();
        });
        const handleEnd = () => {
            isDragging = false;
            isResizing = false;
        };
        canvas.addEventListener(isTouchDevice ? 'touchend' : 'mouseup', handleEnd);
        canvas.addEventListener(isTouchDevice ? 'touchcancel' : 'mouseout', handleEnd);

        function downloadImage(quality) {
            const hasText = textInput.value.trim() !== '';
            if (!img && !hasText) {
                alert(translations[currentLang].alertImage);
                return;
            }
            
            const tempDownloadCanvas = document.createElement('canvas');
            const tempDownloadCtx = tempDownloadCanvas.getContext('2d');
            
            let finalWidth, finalHeight;

            if (img) {
                const scale = {
                    'high': 1.0,
                    'medium': 0.75,
                    'low': 0.5
                }[quality];
                finalWidth = originalImgSize.width * scale;
                finalHeight = originalImgSize.height * scale;
                tempDownloadCanvas.width = finalWidth;
                tempDownloadCanvas.height = finalHeight;
                tempDownloadCtx.drawImage(img, 0, 0, finalWidth, finalHeight);
            } else {
                 if (!hasText) {
                    finalWidth = 500;
                    finalHeight = 300;
                    tempDownloadCanvas.width = finalWidth;
                    tempDownloadCanvas.height = finalHeight;
                    tempDownloadCtx.fillStyle = "#e0e0e0";
                    tempDownloadCtx.fillRect(0, 0, tempDownloadCanvas.width, tempDownloadCanvas.height);
                 } else {
                    const textToDraw = textInput.value;
                    const scale = {
                        'high': 1.0,
                        'medium': 0.75,
                        'low': 0.5
                    }[quality];
                    tempDownloadCtx.font = `${100 * scale}px ${currentFont}`;
                    const textMetrics = tempDownloadCtx.measureText(textToDraw);
                    const paddingX = (backdropWidthPercentage / 100) * 500 * scale;
                    const paddingY = (backdropHeightPercentage / 100) * 300 * scale;
                    finalWidth = textMetrics.width + paddingX;
                    finalHeight = 100 * 1.5 * scale + paddingY;
                    tempDownloadCanvas.width = finalWidth;
                    tempDownloadCanvas.height = finalHeight;
                    tempDownloadCtx.fillStyle = "#e0e0e0";
                    tempDownloadCtx.fillRect(0, 0, tempDownloadCanvas.width, tempDownloadCanvas.height);
                 }
            }
            
            if (hasText) {
                const textToDraw = textInput.value;
                const canvasTextWidth = textMetrics.width;
                const canvasTextHeight = fontSize * 1.5;
                const canvasBackdropWidth = selectedTextBox.width;
                const canvasBackdropHeight = selectedTextBox.height;

                const finalScale = finalWidth / canvas.width;
                const finalBackdropWidth = canvasBackdropWidth * finalScale;
                const finalBackdropHeight = canvasBackdropHeight * finalScale;
                const finalX = selectedTextBox.x * finalScale;
                const finalY = selectedTextBox.y * finalScale;

                let calculatedFinalFontSize = fontSize;
                if (fontSize > 0) {
                    let tempFontSize = (fontSize / 100) * canvas.width;
                    tempDownloadCtx.font = `${tempFontSize}px ${currentFont}`;
                    let tempMetrics = tempDownloadCtx.measureText(textToDraw);
                    if (tempMetrics.width > canvas.width) {
                        const scaleFactor = (canvas.width / tempMetrics.width) * 0.95;
                        calculatedFinalFontSize = tempFontSize * scaleFactor;
                    } else {
                        calculatedFinalFontSize = tempFontSize;
                    }
                } else {
                    calculatedFinalFontSize = 0;
                }
                const finalFontSize = calculatedFinalFontSize * finalScale;
                const finalRadius = (backdropRadius / 100) * Math.min(finalBackdropWidth, finalBackdropHeight) / 2;

                if (backdropOpacity > 0) {
                    tempDownloadCtx.fillStyle = backdropColor;
                    tempDownloadCtx.globalAlpha = backdropOpacity;
                    
                    tempDownloadCtx.beginPath();
                    tempDownloadCtx.moveTo(finalX + finalRadius, finalY);
                    tempDownloadCtx.lineTo(finalX + finalBackdropWidth - finalRadius, finalY);
                    tempDownloadCtx.arcTo(finalX + finalBackdropWidth, finalY, finalX + finalBackdropWidth, finalY + finalRadius, finalRadius);
                    tempDownloadCtx.lineTo(finalX + finalBackdropWidth, finalY + finalBackdropHeight - finalRadius);
                    tempDownloadCtx.arcTo(finalX + finalBackdropWidth, finalY + finalBackdropHeight, finalX + finalBackdropWidth - finalRadius, finalY + finalBackdropHeight, finalRadius);
                    tempDownloadCtx.lineTo(finalX + finalRadius, finalY + finalBackdropHeight);
                    tempDownloadCtx.arcTo(finalX, finalY + finalBackdropHeight, finalX, finalY + finalBackdropHeight - finalRadius, finalRadius);
                    tempDownloadCtx.lineTo(finalX, finalY + finalRadius);
                    tempDownloadCtx.arcTo(finalX, finalY, finalX + finalRadius, finalY, finalRadius);
                    tempDownloadCtx.closePath();
                    tempDownloadCtx.fill();
                    tempDownloadCtx.globalAlpha = 1;
                }

                tempDownloadCtx.font = `${finalFontSize}px ${currentFont}`;
                tempDownloadCtx.globalAlpha = textOpacity;
                tempDownloadCtx.textAlign = "center";
                tempDownloadCtx.textBaseline = "middle";
                tempDownloadCtx.shadowColor = `rgb(0,0,0)`;
                tempDownloadCtx.shadowBlur = shadowBlur;
                tempDownloadCtx.strokeStyle = `rgb(0,0,0)`;
                tempDownloadCtx.lineWidth = strokeWidth * 2;
                tempDownloadCtx.lineJoin = 'round';
                if (strokeWidth > 0) {
                     tempDownloadCtx.strokeText(textToDraw, finalX + finalBackdropWidth / 2, finalY + finalBackdropHeight / 2);
                }
                tempDownloadCtx.shadowColor = textColor;
                tempDownloadCtx.shadowBlur = glowBlur;
                tempDownloadCtx.fillStyle = textColor;
                tempDownloadCtx.fillText(textToDraw, finalX + finalBackdropWidth / 2, finalY + finalBackdropHeight / 2);

                tempDownloadCtx.globalAlpha = 1;
                tempDownloadCtx.shadowBlur = 0;
            }

            const link = document.createElement('a');
            link.download = `edited_image_${quality}.png`;
            link.href = tempDownloadCanvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            drawCanvas();
        }
        
        function downloadText(quality) {
            const hasText = textInput.value.trim() !== '';
            if (!hasText) {
                alert(translations[currentLang].alertText);
                return;
            }
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            const textToDraw = textInput.value;
            const scale = {
                'high': 1.0,
                'medium': 0.75,
                'low': 0.5
            }[quality];

            const baseWidth = 500;
            const baseHeight = 300;

            tempCtx.font = `${100 * scale}px ${currentFont}`;
            const textMetrics = tempCtx.measureText(textToDraw);

            const paddingX = (backdropWidthPercentage / 100) * baseWidth * scale;
            const paddingY = (backdropHeightPercentage / 100) * baseHeight * scale;
            
            tempCanvas.width = textMetrics.width + paddingX;
            tempCanvas.height = 100 * 1.5 * scale + paddingY;
            
            const borderRadius = (backdropRadius / 100) * Math.min(tempCanvas.width, tempCanvas.height) / 2;

            if (backdropOpacity > 0) {
                tempCtx.fillStyle = backdropColor;
                tempCtx.globalAlpha = backdropOpacity;
                
                tempCtx.beginPath();
                tempCtx.moveTo(borderRadius, 0);
                tempCtx.lineTo(tempCanvas.width - borderRadius, 0);
                tempCtx.arcTo(tempCanvas.width, 0, tempCanvas.width, borderRadius, borderRadius);
                tempCtx.lineTo(tempCanvas.width, tempCanvas.height - borderRadius);
                tempCtx.arcTo(tempCanvas.width, tempCanvas.height, tempCanvas.width - borderRadius, tempCanvas.height, borderRadius);
                tempCtx.lineTo(borderRadius, tempCanvas.height);
                tempCtx.arcTo(0, tempCanvas.height, 0, tempCanvas.height - borderRadius, borderRadius);
                tempCtx.lineTo(0, borderRadius);
                tempCtx.arcTo(0, 0, borderRadius, 0, borderRadius);
                tempCtx.closePath();
                tempCtx.fill();
                tempCtx.globalAlpha = 1;
            }
            
            let calculatedDownloadFontSize = (fontSize / 100) * baseWidth;
            tempCtx.font = `${calculatedDownloadFontSize}px ${currentFont}`;
            const tempMetrics = tempCtx.measureText(textToDraw);
            if (tempMetrics.width > baseWidth) {
                const scaleFactor = (baseWidth / tempMetrics.width) * 0.95;
                calculatedDownloadFontSize *= scaleFactor;
            }
            calculatedDownloadFontSize *= scale;

            tempCtx.font = `${calculatedDownloadFontSize}px ${currentFont}`;
            tempCtx.fillStyle = textColor;
            tempCtx.globalAlpha = textOpacity;
            tempCtx.textAlign = "center";
            tempCtx.textBaseline = "middle";
            
            tempCtx.shadowColor = `rgb(0,0,0)`;
            tempCtx.shadowBlur = shadowBlur * scale;
            tempCtx.strokeStyle = `rgb(0,0,0)`;
            tempCtx.lineWidth = strokeWidth * 2 * scale;
            tempCtx.lineJoin = 'round';
            if (strokeWidth > 0) {
                 tempCtx.strokeText(textToDraw, tempCanvas.width / 2, tempCanvas.height / 2);
            }
            tempCtx.shadowColor = textColor;
            tempCtx.shadowBlur = glowBlur * scale;
            tempCtx.fillStyle = textColor;
            tempCtx.fillText(textToDraw, tempCanvas.width / 2, tempCanvas.height / 2);
            tempCtx.globalAlpha = 1;
            tempCtx.shadowBlur = 0;

            const link = document.createElement('a');
            link.download = `text_only_${quality}.png`;
            link.href = tempCanvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        downloadHighBtn.addEventListener('click', () => downloadImage('high'));
        downloadMediumBtn.addEventListener('click', () => downloadImage('medium'));
        downloadLowBtn.addEventListener('click', () => downloadImage('low'));
        
        downloadTextHighBtn.addEventListener('click', () => downloadText('high'));
        downloadTextMediumBtn.addEventListener('click', () => downloadText('medium'));
        downloadTextLowBtn.addEventListener('click', () => downloadText('low'));
        
        copyStickerBtn.addEventListener('click', () => {
            const hasText = textInput.value.trim() !== '';
            if (!hasText) {
                alert(translations[currentLang].alertNoTextToCopy);
                return;
            }

            const offscreenCanvas = document.createElement('canvas');
            const offscreenCtx = offscreenCanvas.getContext('2d');
            const textToDraw = textInput.value;

            const baseFontSize = 100;
            offscreenCtx.font = `${baseFontSize}px ${currentFont}`;
            const textMetrics = offscreenCtx.measureText(textToDraw);

            const baseWidth = 500;
            const baseHeight = 300;

            const paddingX = (backdropWidthPercentage / 100) * baseWidth;
            const paddingY = (backdropHeightPercentage / 100) * baseHeight;
            
            offscreenCanvas.width = textMetrics.width + paddingX + 20; 
            offscreenCanvas.height = baseFontSize * 1.5 + paddingY + 20;

            const borderRadius = (backdropRadius / 100) * Math.min(offscreenCanvas.width, offscreenCanvas.height) / 2;
            const centerX = offscreenCanvas.width / 2;
            const centerY = offscreenCanvas.height / 2;
            const backdropX = centerX - (offscreenCanvas.width - 20) / 2;
            const backdropY = centerY - (offscreenCanvas.height - 20) / 2;
            const backdropWidth = offscreenCanvas.width - 20;
            const backdropHeight = offscreenCanvas.height - 20;
            
            if (backdropOpacity > 0) {
                offscreenCtx.fillStyle = backdropColor;
                offscreenCtx.globalAlpha = backdropOpacity;
                
                offscreenCtx.beginPath();
                offscreenCtx.moveTo(backdropX + borderRadius, backdropY);
                offscreenCtx.lineTo(backdropX + backdropWidth - borderRadius, backdropY);
                offscreenCtx.arcTo(backdropX + backdropWidth, backdropY, backdropX + backdropWidth, backdropY + borderRadius, borderRadius);
                offscreenCtx.lineTo(backdropX + backdropWidth, backdropY + backdropHeight - borderRadius);
                offscreenCtx.arcTo(backdropX + backdropWidth, backdropY + backdropHeight, backdropX + backdropWidth - borderRadius, backdropY + backdropHeight, borderRadius);
                offscreenCtx.lineTo(backdropX + borderRadius, backdropY + backdropHeight);
                offscreenCtx.arcTo(backdropX, backdropY + backdropHeight, backdropX, backdropY + backdropHeight - borderRadius, borderRadius);
                offscreenCtx.lineTo(backdropX, backdropY + borderRadius);
                offscreenCtx.arcTo(backdropX, backdropY, backdropX + borderRadius, backdropY, borderRadius);
                offscreenCtx.closePath();
                offscreenCtx.fill();
                offscreenCtx.globalAlpha = 1;
            }

            offscreenCtx.font = `${baseFontSize}px ${currentFont}`;
            offscreenCtx.fillStyle = textColor;
            offscreenCtx.globalAlpha = textOpacity;
            offscreenCtx.textAlign = "center";
            offscreenCtx.textBaseline = "middle";
            offscreenCtx.fillText(textToDraw, centerX, centerY);
            offscreenCtx.globalAlpha = 1;

            offscreenCanvas.toBlob(async (blob) => {
                const item = new ClipboardItem({'image/png': blob});
                try {
                    await navigator.clipboard.write([item]);
                    alert(translations[currentLang].alertCopySuccess);
                } catch (err) {
                    console.error('Failed to copy image: ', err);
                    alert('خطا در کپی کردن استیکر. مرورگر شما از این قابلیت پشتیبانی نمی‌کند یا دسترسی لازم را ندارد.');
                }
            }, 'image/png');
        });

        setLanguage('fa');
        drawCanvas();
    </script>
</body>
</html>



